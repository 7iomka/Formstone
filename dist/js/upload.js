/*! formstone v1.2.2 [upload.js] 2016-08-10 | GPL-3.0 License | formstone.it */

!function(a){"function"==typeof define&&define.amd?define(["jquery","./core"],a):a(jQuery,Formstone)}(function(a,b){"use strict";function c(a){if(b.support.file){var c="";b.blobSliceMethod||(a.chunked=!1),a.label!==!1&&(c+='<div class="'+y.target+'">',c+=a.label,c+="</div>"),c+='<input class="'+y.input+'" type="file"',a.multiple&&(c+=" multiple"),a.accept&&(c+=' accept="'+a.accept+'"'),c+=">",a.baseClasses=[y.base,a.theme,a.customClass].join(" "),this.addClass(a.baseClasses).append(c),a.$input=this.find(x.input),a.queue=[],a.total=0,a.uploading=!1,a.disabled=!0,a.aborting=!1,this.on(z.click,x.target,a,j).on(z.dragEnter,a,n).on(z.dragOver,a,o).on(z.dragLeave,a,p).on(z.drop,a,q),a.$input.on(z.focus,a,k).on(z.blur,a,l).on(z.change,a,m),i.call(this,a)}}function d(a){b.support.file&&(a.$input.off(z.namespace),this.off(z.namespace).removeClass(a.baseClasses).html(""))}function e(b,c){var d;b.aborting=!0;for(var e in b.queue)b.queue.hasOwnProperty(e)&&(d=b.queue[e],("undefined"===a.type(c)||c>=0&&d.index===c)&&(d.started&&!d.complete?b.chunked?d.chunkTransfer.abort():d.transfer.abort():f(b,d,"abort")));b.aborting=!1,t(b)}function f(a,b,c){b.error=!0,a.$el.trigger(z.fileError,[b,c]),a.aborting||t(a)}function g(a,b,c){a.$el.trigger(z.chunkError,[b,c]),f(a,b,c)}function h(a){a.disabled||(this.addClass(y.disabled),a.$input.prop("disabled",!0),a.disabled=!0)}function i(a){a.disabled&&(this.removeClass(y.disabled),a.$input.prop("disabled",!1),a.disabled=!1)}function j(a){A.killEvent(a);var b=a.data;b.disabled||b.$input.trigger(z.click)}function k(a){a.data.$el.addClass(y.focus)}function l(a){a.data.$el.removeClass(y.focus)}function m(a){A.killEvent(a);var b=a.data,c=b.$input[0].files;!b.disabled&&c.length&&r(b,c)}function n(a){A.killEvent(a);var b=a.data;b.$el.addClass(y.dropping).trigger(z.fileDragEnter)}function o(a){A.killEvent(a);var b=a.data;b.$el.addClass(y.dropping).trigger(z.fileDragOver)}function p(a){A.killEvent(a);var b=a.data;b.$el.removeClass(y.dropping).trigger(z.fileDragLeave)}function q(a){A.killEvent(a);var b=a.data,c=a.originalEvent.dataTransfer.files;b.$el.removeClass(y.dropping),b.disabled||r(b,c)}function r(a,b){for(var c=[],d=0;d<b.length;d++){var e={index:a.total++,file:b[d],name:b[d].name,size:b[d].size,started:!1,complete:!1,error:!1,transfer:null};c.push(e),a.queue.push(e)}a.$el.trigger(z.queued,[c]),a.autoUpload&&s(a),a.$input.val("")}function s(a){a.uploading||(B.on(z.beforeUnload,function(){return a.leave}),a.uploading=!0,a.$el.trigger(z.start,[a.queue])),t(a)}function t(a){var b=0,c=[];for(var d in a.queue)!a.queue.hasOwnProperty(d)||a.queue[d].complete||a.queue[d].error||c.push(a.queue[d]);a.queue=c;for(var e in a.queue)if(a.queue.hasOwnProperty(e)){if(!a.queue[e].started){var f=new FormData;a.chunked||f.append(a.postKey,a.queue[e].file);for(var g in a.postData)a.postData.hasOwnProperty(g)&&f.append(g,a.postData[g]);u(a,f,a.queue[e])}if(b++,b>=a.maxQueue)return;d++}0===b&&(B.off(z.beforeUnload),a.uploading=!1,a.$el.trigger(z.complete))}function u(b,c,d){c=b.beforeSend.call(b.$el,c,d),d.size>=b.maxSize||c===!1||d.error===!0?f(b,d,c?"size":"abort"):b.chunked?(d.started=!0,d.chunkSize=1024*b.chunkSize,d.totalChunks=Math.ceil(d.size/d.chunkSize),d.currentChunk=0,c.append("chunks",d.totalChunks),b.$el.trigger(z.fileStart,[d]),v(b,c,d)):(d.started=!0,d.transfer=a.ajax({url:b.action,data:c,dataType:b.dataType,type:"POST",contentType:!1,processData:!1,cache:!1,xhr:function(){var c=a.ajaxSettings.xhr();return c.upload&&c.upload.addEventListener("progress",function(a){var c=0,e=a.loaded||a.position,f=a.total;a.lengthComputable&&(c=Math.ceil(e/f*100)),b.$el.trigger(z.fileProgress,[d,c])},!1),c},beforeSend:function(a,c){b.$el.trigger(z.fileStart,[d])},success:function(a,c,e){d.complete=!0,b.$el.trigger(z.fileComplete,[d,a]),t(b)},error:function(a,c,e){f(b,d,e)}}))}function v(c,d,e){var f=e.chunkSize*e.currentChunk,h=f+e.chunkSize;h>e.size&&(h=e.size);var i=e.file[b.blobSliceMethod](f,h);d.set("chunk",e.currentChunk),d.set(c.postKey,i,e.file.name),e.chunkTransfer=a.ajax({url:c.action,data:d,dataType:c.dataType,type:"POST",contentType:!1,processData:!1,cache:!1,beforeSend:function(a,b){c.$el.trigger(z.chunkStart,[e])},success:function(a,b,f){e.currentChunk++,c.$el.trigger(z.chunkComplete,[e]);var g=Math.ceil(e.currentChunk/e.totalChunks*100);c.$el.trigger(z.fileProgress,[e,g]),e.currentChunk<e.totalChunks?setTimeout(v(c,d,e),1):(e.complete=!0,c.$el.trigger(z.fileComplete,[e,a]),t(c))},error:function(a,b,d){g(c,e,d)}})}var w=b.Plugin("upload",{widget:!0,defaults:{accept:!1,action:"",autoUpload:!0,beforeSend:function(a){return a},chunked:!1,chunkSize:100,customClass:"",dataType:"html",label:"Drag and drop files or click to select",leave:"You have uploads pending, are you sure you want to leave this page?",maxQueue:2,maxSize:5242880,multiple:!0,postData:{},postKey:"file",theme:"fs-light"},classes:["input","target","multiple","dropping","disabled","focus"],methods:{_construct:c,_destruct:d,disable:h,enable:i,abort:e,start:s}}),x=w.classes,y=x.raw,z=w.events,A=w.functions,B=(b.window,b.$window);z.chunkComplete="chunkcomplete",z.chunkError="chunkerror",z.chunkStart="chunkstart",z.complete="complete",z.fileComplete="filecomplete",z.fileDragEnter="filedragenter",z.fileDragLeave="filedragleave",z.fileDragOver="filedragover",z.fileError="fileerror",z.fileProgress="fileprogress",z.fileStart="filestart",z.start="start",z.queued="queued"});