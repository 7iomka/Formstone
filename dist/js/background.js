/*! Formstone v0.0.1 [background.js] 2014-12-27 | MIT License | formstone.it */

!function(a,b){"use strict";function c(){x.on(u.resize,d),d()}function d(){z.length&&(C=v.startTimer(C,D,function(){v.iterate.call(z,o)})),B=x.width()}function e(){z=a(s.base)}function f(b){b.guid="__"+A++,b.youTubeGuid=0,b.eventGuid=u.namespace+b.guid,b.rawClassGuid=t.base+b.guid,b.classGuid="."+b.rawClassGuid,b.$container=a('<div class="'+t.container+'"></div>').appendTo(this),this.addClass(t.base);var c=b.source;b.source=null,h(b,c,!0),e()}function g(a){a.$container.remove(),this.removeClass(t.base).off(u.namespace),e()}function h(b,c,d){if(c!==b.source){if(b.source=c,b.isYouTube=!1,"object"===a.type(c)&&"string"===a.type(c.video)){var e=c.video.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/ ]{11})/i);e&&e.length>=1&&(b.isYouTube=!0,b.videoId=e[1])}if(b.isYouTube)b.playing=!1,b.playerReady=!1,b.posterLoaded=!1,m(b,c,d);else if("object"!==a.type(c)||c.hasOwnProperty("fallback")){if(b.responsiveSource)for(var f in b.responsiveSource)b.responsiveSource.hasOwnProperty(f)&&b.responsiveSource[f].mq.removeListener(p);if(b.responsive=!1,b.responsiveSource=null,"object"===a.type(c)){var g,h=[];b.responsive=!0,b.responsiveSource=h,c=g}k(b,c,!1,d)}else l(b,c,d)}else b.$el.trigger(u.loaded)}function i(a){if(a.isYouTube&&a.playerReady)a.player.pauseVideo();else{var b=a.$container.find("video");b.length&&b[0].pause()}}function j(a){if(a.isYouTube&&a.playerReady)a.player.playVideo();else{var b=a.$container.find("video");b.length&&b[0].play()}}function k(b,c,d,e){var f=[t.media,t.image,e!==!0?t.animated:""].join(" "),g=a('<div class="'+f+'"><img></div>'),h=g.find("img"),i=c;h.one(u.load,function(){E&&g.addClass(t["native"]).css({backgroundImage:"url('"+i+"')"}),g.transition({property:"opacity"},function(){d||n(b)}).css({opacity:1}),o(b),(!d||e)&&b.$el.trigger(u.loaded)}).attr("src",i),b.responsive&&g.addClass(s.responsive),b.$container.append(g),(h[0].complete||4===h[0].readyState)&&h.trigger(u.load)}function l(c,d,e){if(c.source&&c.source.poster&&(k(c,c.source.poster,!0,!0),e=!1),!b.isMobile){var f=[t.media,t.video,e!==!0?t.animated:""].join(" "),g='<div class="'+f+'">';g+="<video",c.loop&&(g+=" loop"),c.mute&&(g+=" muted"),g+=">",c.source.webm&&(g+='<source src="'+c.source.webm+'" type="video/webm" />'),c.source.mp4&&(g+='<source src="'+c.source.mp4+'" type="video/mp4" />'),c.source.ogg&&(g+='<source src="'+c.source.ogg+'" type="video/ogg" />'),g+="</video>",g+="</div>";var h=a(g),l=h.find("video");l.one(u.loadedMetaData,function(){h.transition({property:"opacity"},function(){n(c)}).css({opacity:1}),o(c),c.$el.trigger(u.loaded),c.hoverPlay?c.$el.on(u.mouseOver,j).on(u.mouseOut,i):c.autoPlay&&this.play()}),c.$container.append(h)}}function m(c,d,e){if(!c.videoId){var f=d.match(/^.*(?:youtu.be\/|v\/|e\/|u\/\w+\/|embed\/|v=)([^#\&\?]*).*/);c.videoId=f[1]}if(c.posterLoaded||(c.source.poster||(c.source.poster="http://img.youtube.com/vi/"+c.videoId+"/0.jpg"),c.posterLoaded=!0,k(c,c.source.poster,!0,e),e=!1),!b.isMobile)if(a("script[src*='youtube.com/iframe_api']").length||a("head").append('<script src="//www.youtube.com/iframe_api"></script>'),F){var g=c.guid+"_"+c.youTubeGuid++,h=[t.media,t.embed,e!==!0?t.animated:""].join(" "),l='<div class="'+h+'">';l+='<div id="'+g+'"></div>',l+="</div>";var m=a(l);c.$container.append(m),c.player&&(c.oldPlayer=c.player,c.player=null),c.player=new window.YT.Player(g,{videoId:c.videoId,playerVars:{controls:0,rel:0,showinfo:0,wmode:"transparent",enablejsapi:1,version:3,playerapiid:g,loop:c.loop?1:0,autoplay:1,origin:window.location.protocol+"//"+window.location.host},events:{onReady:function(){c.playerReady=!0,c.mute&&c.player.mute(),c.hoverPlay?c.$el.on(u.mouseOver,j).on(u.mouseOut,i):c.autoPlay&&c.player.playVideo()},onStateChange:function(a){c.playing||a.data!==window.YT.PlayerState.PLAYING?c.loop&&c.playing&&a.data===window.YT.PlayerState.ENDED&&c.player.playVideo():(c.playing=!0,(c.hoverPlay||!c.autoPlay)&&c.player.pauseVideo(),m.transition({property:"opacity"},function(){n(c)}).css({opacity:1}),o(c),c.$el.trigger(u.loaded)),c.$el.find(s.embed).addClass(t.ready)},onPlaybackQualityChange:function(){},onPlaybackRateChange:function(){},onError:function(){},onApiChange:function(){}}}),o(c)}else G.push({data:c,source:d})}function n(a){var b=a.$container.find(s.media);b.length>=1&&(b.not(":last").remove(),a.oldPlayer=null)}function o(a){for(var b=a.$container.find(s.media),c=0,d=b.length;d>c;c++){var e=b.eq(c),f=a.isYouTube?"iframe":e.find("video").length?"video":"img",g=e.find(f);if(g.length&&("img"!==f||!E)){var h=a.$el.outerWidth(),i=a.$el.outerHeight(),j=q(a,g);a.width=j.width,a.height=j.height,a.left=0,a.top=0;var k=a.isYouTube?a.embedRatio:a.width/a.height;a.height=i,a.width=a.height*k,a.width<h&&(a.width=h,a.height=a.width/k),a.left=-(a.width-h)/2,a.top=-(a.height-i)/2,e.css({height:a.height,width:a.width,left:a.left,top:a.top})}}}function p(){}function q(b,c){if(b.isYouTube)return{height:500,width:500/b.embedRatio};if(c.is("img")){var d=c[0];if("undefined"!==a.type(d.naturalHeight))return{height:d.naturalHeight,width:d.naturalWidth};var e=new Image;return e.src=d.src,{height:e.height,width:e.width}}return{height:c[0].videoHeight,width:c[0].videoWidth}}var r=b.Plugin("background",{widget:!0,defaults:{autoPlay:!0,customClass:"",embedRatio:1.777777,hoverPlay:!1,loop:!0,mute:!0,source:null},classes:["container","media","animated","responsive","native","fixed","ready"],events:{loaded:"loaded",ready:"ready",loadedMetaData:"loadedmetadata"},methods:{_setup:c,_construct:f,_destruct:g,play:j,pause:i,load:h}}),s=r.classes,t=s.raw,u=r.events,v=r.functions,w=b.window,x=b.$window,y=b.document,z=[],A=0,B=0,C=null,D=20,E="backgroundSize"in y.documentElement.style,F=!1,G=[];w.onYouTubeIframeAPIReady=function(){F=!0;for(var a in G)G.hasOwnProperty(a)&&m(G[a].data,G[a].source);G=[]}}(jQuery,Formstone);