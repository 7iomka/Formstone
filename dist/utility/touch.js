/*! 
 * Formstone v0.0.1 - 2014-11-21 
 * Library of modular javascript components. 
 * http://formstone.it/ 
 * 
 * Copyright 2014 Ben Plum; MIT Licensed 
 */

!function(a,b){"use strict";function c(b,c){b.length&&("string"===a.type(c)&&"destroy"===c?r.iterate.apply(a(b),[e].concat(Array.prototype.slice.call(arguments,1))):r.iterate.apply(a(b),[d].concat(Array.prototype.slice.call(arguments,1))))}function d(b,c){var d=this;r.getData(d)||(b=a.extend(!0,b,{$el:d,touches:[]},c),b.tap?(b.pan=!1,b.scale=!1,d.on(q.touchStart,b,g).on(q.click,b,j)):(b.pan||b.scale)&&(b.tap=!1,d.on([q.touchStart,q.pointerDown].join(" "),b,f),b.pan&&d.on(q.mouseDown,b,g)),d.data(p,b))}function e(){this.off(q.namespace).removeData(p)}function f(a){a.preventManipulation&&a.preventManipulation(),a.preventDefault(),a.stopPropagation();var b=a.data,c=a.originalEvent;if(c.type.match(/(up|end)$/i))return void i(a);if(c.pointerId){var d=!1;for(var e in b.touches)b.touches[e].id===c.pointerId&&(d=!0,b.touches[e].pageX=c.clientX,b.touches[e].pageY=c.clientY);d||b.touches.push({identifier:c.pointerId,pageX:c.clientX,pageY:c.clientY})}else b.touches=c.touches;c.type.match(/(down|start)$/i)?g(a):c.type.match(/move$/i)&&h(a)}function g(b){b.stopPropagation();var c=b.data,d="undefined"!==a.type(b.originalEvent.touches)?b.originalEvent.touches[0]:null;if(c.startE=b.originalEvent,c.startX=d?d.pageX:b.pageX,c.startY=d?d.pageY:b.pageY,c.scaleD=1,c.tap)c.clicked=!1,c.$el.on(q.touchMove,c,h).on([q.touchEnd,q.touchCancel].join(" "),c,i);else if(c.pan||c.scale){r.killEvent(b);var e=k(c.scale?q.scaleStart:q.panStart,b,c.startX,c.startY,c.scaleD,0,0);if(c.scale&&c.touches&&c.touches.length>=2){var g=c.touches;c.pinch={startX:l(g[0].pageX,g[1].pageX),startY:l(g[0].pageY,g[1].pageY),startD:m(g[1].pageX-g[0].pageX,g[1].pageY-g[0].pageY)},e.pageX=c.startX=c.pinch.startX,e.pageY=c.startY=c.pinch.startY}c.pan&&s.on(q.mouseMove,c,h).on(q.mouseUp,c,i),s.on([q.touchMove,q.touchEnd,q.touchCancel,q.pointerMove,q.pointerUp,q.pointerCancel].join(" "),c,f),c.$el.trigger(e)}}function h(b){var c=b.data,d="undefined"!==a.type(b.originalEvent.touches)?b.originalEvent.touches[0]:null,e=d?d.pageX:b.pageX,f=d?d.pageY:b.pageY,g=e-c.startX,h=f-c.startY;if(c.tap&&(Math.abs(e-c.startX)>10||Math.abs(f-c.startY)>10))c.$el.off([q.touchMove,q.touchEnd,q.touchCancel].join(" "));else if(c.pan||c.scale){var i=!0,j=k(c.scale?q.scale:q.pan,b,e,f,c.scaleD,g,h);if(c.scale)if(c.touches&&c.touches.length>=2){var n=c.touches;c.pinch.endX=l(n[0].pageX,n[1].pageX),c.pinch.endY=l(n[0].pageY,n[1].pageY),c.pinch.endD=m(n[1].pageX-n[0].pageX,n[1].pageY-n[0].pageY),c.scaleD=c.pinch.endD/c.pinch.startD,j.pageX=c.pinch.endX,j.pageY=c.pinch.endY,j.scale=c.scaleD,j.deltaX=c.pinch.endX-c.pinch.startX,j.deltaY=c.pinch.endY-c.pinch.startY}else c.pan||(i=!1);i&&c.$el.trigger(j)}}function i(b){var c=b.data;if(c.tap)c.$el.off([q.touchMove,q.touchEnd,q.touchCancel,q.mouseMove,q.mouseUp].join(" ")),c.startE.preventDefault(),j(b);else if(c.pan||c.scale){var d="undefined"!==a.type(b.originalEvent.touches)?b.originalEvent.touches[0]:null,e=d?d.pageX:b.pageX,f=d?d.pageY:b.pageY,g=e-c.startX,h=f-c.startY,i=k(c.scale?q.scaleEnd:q.panEnd,b,e,f,c.scaleD,g,h);s.off([q.touchMove,q.touchEnd,q.touchCancel,q.mouseMove,q.mouseUp,q.pointerMove,q.pointerUp,q.pointerCancel].join(" ")),c.$el.trigger(i)}}function j(a){r.killEvent(a);var b=a.data;if(!b.clicked){"click"!==a.type&&(b.clicked=!0);var c=b.startE?b.startX:a.pageX,d=b.startE?b.startY:a.pageY,e=k(q.tap,a.originalEvent,c,d,1,0,0);b.$el.trigger(e)}}function k(b,c,d,e,f,g,h){return a.Event(b,{pageX:d,pageY:e,scale:f,deltaX:g,deltaY:h,originalEvent:c,bubbles:!0})}function l(a,b){return(a+b)/2}function m(a,b){return Math.sqrt(a*a+b*b)}var n=!!window.PointerEvent,o=b.Plugin("touch",{defaults:{pan:!1,scale:!1,tap:!1},methods:{_delegate:c},events:{pointerDown:n?"MSPointerDown":"pointerdown",pointerUp:n?"MSPointerUp":"pointerup",pointerMove:n?"MSPointerMove":"pointermove",pointerCancel:n?"MSPointerCancel":"pointercancel"}}),p=o.namespace,q=o.events,r=o.functions,s=b.$window;q.tap="tap",q.pan="pan",q.panStart="panstart",q.panEnd="panend",q.scale="scale",q.scaleStart="scalestart",q.scaleEnd="scaleend"}(jQuery,Formstone);